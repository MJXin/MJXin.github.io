---
title: OCåŸºçŸ³ -- Runloop é™„å½•ï¼šå…¶ä»–å‡½æ•°è§£æ(`CFRunLoopDoObservers`ã€`__CFRunLoopDoBlocks`ã€`__CFRunLoopDoSources0`)    
key: test
excerpt_separator: <!--more-->
excerpt_type: html # text (default), html
picture_frame: shadow
tags: æºç è§£æ OCåŸºçŸ³
coding: UTF-8
--- 
> æºç æ¥æº:  https://opensource.apple.com/tarballs/CF/    
> ä½¿ç”¨çš„æºç ç‰ˆæœ¬: [CF-1151.16.tar](/assets/images/æºç è§£æ/runloop/CF-1151.16.tar)   
  
## runloop åˆ›å»ºç›¸å…³çš„å‡½æ•°  
### `_CFRunLoopGet0`  
å¤–éƒ¨è·å–æŸä¸ªçº¿ç¨‹çš„ runloop æ—¶ä½¿ç”¨  
1. **ç©ºå€¼åˆ¤æ–­**: å½“ä¼ å…¥çº¿ç¨‹ä¸º ç©º æ—¶, é»˜è®¤ä¸ºä¸»çº¿ç¨‹  
```objc  
if (pthread_equal(t, kNilPthreadT)) {  
    t = pthread_main_thread_np();  
}  
```  
2. **å…¨å±€åˆå§‹åŒ–**: `__CFRunLoops`æ˜¯ä¸ªå…¨å±€å˜é‡, ä½†è¿™ä¸ªå˜é‡ä¸ºç©ºæ—¶,è¯æ˜ runloop çš„ç¯å¢ƒæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œéœ€è¦åˆ›å»ºä¸€äº›å…¨å±€å˜é‡  
`dict`: ç»“åˆåé¢ä¼šçœ‹åˆ°, è¿™æ˜¯ä¸ªå­˜å‚¨äº†å…¨å±€ runloop çš„é›†åˆ  
`mainLoop`: å³ä¸»çº¿ç¨‹çš„ runloop, ä¼šåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ä¸€å—åˆå§‹åŒ–, ä¹‹åä¼šæ·»åŠ è¿› dict ä¸­  
```objc  
if (!__CFRunLoops) {  
    CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &kCFTypeDictionaryValueCallBacks);  
    CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());  
    CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);  
}  
```  
3. **loop è·å–**: åé¢ä¼šä½¿ç”¨çº¿ç¨‹å°è¯•è·å–ä¸€æ¬¡ loop, è‹¥æ˜¯æ‹¿ä¸åˆ°åˆ™åˆ›å»ºä¸€ä¸ª, è‹¥æ˜¯èƒ½æ‹¿åˆ°åˆ™ç›´æ¥è¿”å›   

```objc  
CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));  
if (!loop) {  
	CFRunLoopRef newLoop = __CFRunLoopCreate(t);  
	// ä¼šå†æ‹¿ä¸€æ¬¡, ä¸çŸ¥é“ä¸ºå•¥, __CFRunLoopCreateä¸­ä¹Ÿæ²¡æœ‰åŠ å…¥çš„æ“ä½œ  
	loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));  
	if (!loop) {  
		CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);  
		loop = newLoop;  
	}  
}  
// ...æœ‰çœç•¥  
return loop;  

```  

### `__CFRunLoopCreate`  
ä¸»è¦æ˜¯è°ƒç”¨ `_CFRuntimeCreateInstance` ç„¶åèµ‹åˆå§‹å€¼çš„æ“ä½œ  
### `_CFRuntimeCreateInstance`:  
 - [ ] å†…éƒ¨çš„ä»£ç å·²ç»åˆ° CFRuntime è¿™ä¸€å±‚äº†, æš‚æ—¶ä¸åšæ·±å…¥,å…ˆå›åˆ° runloop ä¸»çº¿  
  
## runloop æ‰§è¡Œç›¸å…³çš„å‡½æ•°  
### æ€»ç»“:  
* ä¼šå‘ç° doXXX å‡½æ•°, æœ€ç»ˆçš„æ ¸å¿ƒéƒ¨åˆ†éƒ½æ˜¯è°ƒç”¨ `__CFRUNLOOP_IS_CALLING_OUT_TO xxx` çš„å‡½æ•°  
* `__CFRUNLOOP_IS_CALLING_OUT_TO` åŸºæœ¬ä¸Šæ‰€æœ‰çš„å®ç°,æ‰§è¡Œå¤–éƒ¨ä¼ å…¥å‡½æ•°æŒ‡é’ˆ, æ—¢<mark>çœŸæ­£çš„æ‰§è¡Œå¤–ç•Œå‡½æ•°</mark>  
  
### å¾ˆå¤šåœ°æ–¹è°ƒç”¨çš„`CFGetTypeID(sources)`æ˜¯ä»€ä¹ˆ  
ä¸‹é¢æ¢ç©¶çš„å‡½æ•°ä¸­, å¾ˆå¤šåœ°æ–¹éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªåˆ¤æ–­,  
è™½ç„¶ä¸æ˜¯æ¯ä¸ªåœ°æ–¹éƒ½æœ‰æ³¨é‡Š, å¹¶ä¸”æœ€ç»ˆè¿½æº¯ä¹Ÿåªèƒ½å…¶å¯¹æ¯”çš„å€¼æ˜¯ 0.  
ä½†æ˜¯é€šè¿‡å…¶é€»è¾‘å’Œéƒ¨åˆ†æ³¨é‡Š, èƒ½å¾—å‡ºç»“è®º <mark>è¿™æ˜¯ä¸€ä¸ªåˆ¤æ–­æŸä¸ªæŒ‡é’ˆæ˜¯**å•ä¸ªå…ƒç´ **, è¿˜æ˜¯**é›†åˆ_é“¾è¡¨_æ•°ç»„**çš„åˆ¤æ–­</mark>  
(`CFStringGetTypeID` -> `__kCFStringTypeID` -> `_kCFRuntimeNotATypeID` -> `0`)  
(`CFRunLoopSourceGetTypeID` -> `_kCFRuntimeNotATypeID` -> `0`)  

```objc  
// sources is either a single (retained) CFRunLoopSourceRef or an array of (retained) CFRunLoopSourceRef  
CFGetTypeID(sources) == CFRunLoopSourceGetTypeID()  
CFStringGetTypeID() == CFGetTypeID(mode)  
CFStringGetTypeID() == CFGetTypeID(curr->_mode)  
CFGetTypeID(item) == CFRunLoopSourceGetTypeID()  
CFStringGetTypeID() == CFGetTypeID(curr->_mode)  

```  
  
ps.æˆ‘æ¨æµ‹å…¶åŸç†ç±»ä¼¼äºä¹‹å‰ç ”ç©¶çš„ runtime çš„ isa æŠ€æœ¯ [å…¶ä»–: Tagged pointer ä¸ isa](bear://x-callback-url/open-note?id=DD6BA620-7369-40F2-8076-EEFCFF947C69-477-00005195DB13B02E)  
  
### `__CFRunLoopDoObservers`  
[CFRunLoop.c](/assets/images/æºç è§£æ/runloop/CFRunLoop.c)  
æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ª: for å¾ªç¯å–å‡º Observer, å¾ªç¯ä¸­ç»è¿‡ä¸€ç³»åˆ—æ“ä½œåæ‰§è¡Œ  
`__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__`  
  
è¿™ä¸ªå‡½æ•°ä¼šçœŸæ­£çš„è°ƒç”¨ [`__CFRunLoopObserver`](bear://x-callback-url/open-note?id=8952945C-170E-4D74-A955-C843D3DBF200-19321-00002DEC794F7F79&header=%60CFRunLoopObserverRef%60%20%26%20%60__CFRunLoopObserver%60)ä¸­çš„å›è°ƒ  
  
1. å…ˆæ‹¿ Set ä¸­çš„ Observers ä¸ªæ•°, ç„¶åæ‹¿å»ç”³è¯·å†…å­˜, ä¹‹åé€ä¸ªåŠ å…¥æ•°ç»„ä¸­(ä»£ç æœ‰çœç•¥)   
```objc  
  // è·å–ä¸ªæ•°  
  CFIndex cnt = rlm->_observers ? CFArrayGetCount(rlm->_observers) : 0;  
  // æ ¹æ®æƒ…å†µç”³è¯·ç©ºé—´  
  CFRunLoopObserverRef *collectedObservers = (cnt <= 1024) ? buffer : (CFRunLoopObserverRef *)malloc(cnt * sizeof(CFRunLoopObserverRef));  
  // åŠ å…¥æ•°ç»„  
  for (CFIndex idx = 0; idx < cnt; idx++) {  
    collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo);  
  }  
```
2. æ¥ä¸‹æ¥æ˜¯æ ¸å¿ƒéƒ¨åˆ†: for å¾ªç¯å¤–éƒ¨æœ‰é”æ“ä½œ(ğŸ”²å…·ä½“é”ä»¥åè§†æƒ…å†µæ¢ç©¶,æš‚æ—¶ä¸æ·±å…¥)  
```objc  
__CFRunLoopModeUnlock(rlm);  
__CFRunLoopUnlock(rl);  
for (CFIndex idx = 0; idx < obs_cnt; idx++) {...}  
__CFRunLoopLock(rl);  
__CFRunLoopModeLock(rlm);  
```

3.for å¾ªç¯å†…éƒ¨: æœ€ç»ˆæ­£ç¡®çš„ä¼šæ‰§è¡Œ `__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ `  
æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨`__CFRunLoopObserverSetFiring` å’Œ `__CFRunLoopObserverUnsetFiring`ä¿®æ”¹æ ‡è®°,è¿½è¸ªæºç , è¿™æ˜¯ä¸ªåšè®¡ç®—çš„å®  
ä¸»è¦æ˜¯è¿™äº›æ“ä½œ:  
1. éªŒè¯æœ‰æ•ˆæ€§  
2. éªŒè¯é‡å¤  
3. æ ‡è®°ä¸º `Firing`  
4. **æ ¸å¿ƒä»£ç **: è°ƒç”¨`__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__`, çœŸæ­£çš„æ‰§è¡Œå›è°ƒ  
5. å–æ¶ˆæ ‡è®°`Firing`  
```objc  
for (CFIndex idx = 0; idx < obs_cnt; idx++) {  
    CFRunLoopObserverRef rlo = collectedObservers[idx];  
    __CFRunLoopObserverLock(rlo);  
    if (__CFIsValid(rlo)) {  
        Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);  
        __CFRunLoopObserverSetFiring(rlo);  
        __CFRunLoopObserverUnlock(rlo);  
        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(rlo->_callout, rlo, activity, rlo->_context.info);  
        if (doInvalidate) {  
            CFRunLoopObserverInvalidate(rlo);  
        }  
        __CFRunLoopObserverUnsetFiring(rlo);  
    } else {  
        __CFRunLoopObserverUnlock(rlo);  
    }  
    CFRelease(rlo);  
}  
```  

```objc  
CF_INLINE void __CFRunLoopObserverSetFiring(CFRunLoopObserverRef rlo) {  
    __CFBitfieldSetValue(((CFRuntimeBase *)rlo)->_cfinfo[CF_INFO_BITS], 0, 0, 1);  
}  
#define __CFBitfieldSetValue(V, N1, N2, X)  ((V) = ((V) & ~__CFBitfieldMask(N1, N2)) | (((X) << (N2)) & __CFBitfieldMask(N1, N2)))  
```  
  
### `__CFRunLoopDoBlocks`  
<a href='/assets/images/æºç è§£æ/runloop/CFRunLoop.c'>CFRunLoop.c</a>  
æ ¸å¿ƒé€»è¾‘æ˜¯: while éå† block çš„é“¾è¡¨ä¸­å–å‡º block,  ç„¶åè°ƒç”¨`__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__`  
`block` å…·ä½“æ˜¯å•¥æˆ‘å†™åœ¨è¿™: [å…¶ä»–: æ•°æ®ç»“æ„æºç è§£æ`block`](bear://x-callback-url/open-note?id=8952945C-170E-4D74-A955-C843D3DBF200-19321-00002DEC794F7F79&header=%60_block_item%60:%20%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%20dispatch%20%E8%BF%9B%E6%9D%A5%E7%9A%84%20%60block%60)  
`CFRunLoopRef` å…·ä½“æ•°æ®ç»“æ„:[å…¶ä»–: æ•°æ®ç»“æ„æºç è§£æ`CFRunLoopRef`](bear://x-callback-url/open-note?id=8952945C-170E-4D74-A955-C843D3DBF200-19321-00002DEC794F7F79&header=%60_block_item%60:%20%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%20dispatch%20%E8%BF%9B%E6%9D%A5%E7%9A%84%20%60block%60)  
  
å¯ä»¥ç†è§£ä¸º, è¿™é‡Œå°±æ˜¯åœ¨å¤„ç†,æˆ‘ä»¬ `dispatch_async`, `dispatch_sync` æ‰€ä¼ å…¥çš„ block  
  
1. ä»æºç è§£æé‚£ç¯‡æ–‡ç« ä¸­å¯ä»¥çœ‹åˆ°, block è¢«ä»¥é“¾è¡¨çš„å½¢å¼å­˜äº†èµ·æ¥, è¿™é‡Œå–å‡ºäº†é“¾è¡¨, ç„¶åæ¸…æ‰ä¹‹å‰å­˜çš„æ•°æ®  
```objc  
struct _block_item *head = rl->_blocks_head;  
struct _block_item *tail = rl->_blocks_tail;  
rl->_blocks_head = NULL;  
rl->_blocks_tail = NULL;  
```   
2. ä¹‹åå°±æ¶‰åŠåˆ°ä¹‹å‰æè¿‡çš„ `common` æ¦‚å¿µ, æ‹¿åˆ°å½“å‰ common çš„æ‰€æœ‰ modes  
âœï¸ è¡¥å…… common çš„è¿æ¥  
```objc  
CFSetRef commonModes = rl->_commonModes;  
```  
3. è¿›å…¥å¾ªç¯ `while (item)`,å¼€å§‹éå†é“¾è¡¨, è¿™é‡Œç›´æ¥çœ‹è¿›å…¥å¾ªç¯å  
4. æ‹¿åˆ°å½“å‰èŠ‚ç‚¹, å¹¶ä¸”å†å¾€ä¸‹èµ°ä¸€ä¸ªå…ƒç´   
```objc  
struct _block_item *curr = item;  
item = item->_next;  
```  
5. åˆ¤æ–­ block çš„ mode , **ä»¥å†³å®š block æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œ**  
* è¿™é‡Œé¢çš„åˆ¤æ–­`CFGetTypeID`, `CFEqual` ç­‰çœ‹ä¸Šé¢ [å¾ˆå¤šåœ°æ–¹è°ƒç”¨çš„`CFGetTypeID(sources)`æ˜¯ä»€ä¹ˆ](bear://x-callback-url/open-note?id=460B8C4E-45D7-45E1-ADA1-930BB7AF5D4A-470-00002CE3191B3685&header=%E5%BE%88%E5%A4%9A%E5%9C%B0%E6%96%B9%E8%B0%83%E7%94%A8%E7%9A%84%60CFGetTypeID%28sources%29%60%E6%98%AF%E4%BB%80%E4%B9%88)  
* æœ€ç»ˆå¤–å±‚åˆ¤æ–­å‡ºæ¥å½“å‰ block çš„ mode æ˜¯å•ä¸€å…ƒç´ , è¿˜æ˜¯ä¸€ä¸ª set  
  * å•ä¸ªå…ƒç´ æ‰§è¡Œä¸‹é¢åˆ¤æ–­:  
    1. block æ‰€å±çš„ mode, æ˜¯å¦ç­‰äºå½“å‰ runloop çš„ mode  
    2. å½“å‰ runloop çš„ mode æ˜¯å¦åœ¨ `common` ä¸­ä¸” block çš„ mode æ˜¯å¦åœ¨ `common`ä¸­  
  * set æ‰§è¡Œä¸‹é¢åˆ¤æ–­:  
    1. å½“å‰ runloop çš„ mode æ˜¯å¦åœ¨ block.mode ä¸­  
    2. CommonMode æ˜¯å¦åŒ…å«äº† block.mode ä¸” CommonMode æ˜¯å¦åŒ…å«å½“å‰ runloop.mode  
```objc  
// CFRunloop.c  
if (CFStringGetTypeID() == CFGetTypeID(curr->_mode)) {  
    doit = CFEqual(curr->_mode, curMode) || (CFEqual(curr->_mode, kCFRunLoopCommonModes) && CFSetContainsValue(commonModes, curMode));  
    } else {  
    doit = CFSetContainsValue((CFSetRef)curr->_mode, curMode) || (CFSetContainsValue((CFSetRef)curr->_mode, kCFRunLoopCommonModes) && CFSetContainsValue(commonModes, curMode));  
}  
```  
6.**æ ¸å¿ƒ** éœ€è¦è¢«æ‰§è¡Œçš„æ“ä½œæœ€åä¼šè°ƒç”¨`__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__`  
```objc  
// çœç•¥ä¸€äº›æŒ‡é’ˆæ“ä½œ  
 if (doit) {  
		__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);  
		did = true;  
}  
```  
  
### `__CFRunLoopDoSources0`  
æ ¸å¿ƒé€»è¾‘: for å¾ªç¯å–å‡º source0, éªŒè¯åæ‰§è¡Œ`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__`  
å…¶å®ä¸ä¸Šé¢å¤§åŒå°å¼‚:  
1. ä¸€äº›æ ¡éªŒæ“ä½œå, åˆ¤æ–­æ˜¯å•ä¸ªå…ƒç´ è¿˜æ˜¯ set  
2. å¦‚æœæ˜¯ set, è¿›å…¥å¾ªç¯, åšæ ¡éªŒ,ç„¶åæ‰§è¡Œ**æ ¸å¿ƒéƒ¨åˆ†**  
`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__`  
  
  
```objc  
// æŠŠä¸œè¥¿å–å‡ºæ¥, CFSetApplyFunction å…¶å®å†…éƒ¨æ˜¯ do-while å®, ä¸»è¦æ˜¯ __CFRunLoopCollectSources0 å‡½æ•°  
 if (NULL != rlm->_sources0 && 0 < CFSetGetCount(rlm->_sources0)) {  
    CFSetApplyFunction(rlm->_sources0, (__CFRunLoopCollectSources0), &sources);  
}  
```  
  
  
```objc  
//å¾ªç¯å’Œéå¾ªç¯ç±»ä¼¼, éƒ½æ˜¯æ‰§è¡Œä¸‹é¢çš„, æœ€ç»ˆæ‰§è¡Œåˆ°`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__`  
CFIndex cnt = CFArrayGetCount((CFArrayRef)sources);  
CFArraySortValues((CFMutableArrayRef)sources, CFRangeMake(0, cnt), (__CFRunLoopSourceComparator), NULL);  
for (CFIndex idx = 0; idx < cnt; idx++) {  
CFRunLoopSourceRef rls = (CFRunLoopSourceRef)CFArrayGetValueAtIndex((CFArrayRef)sources, idx);  
__CFRunLoopSourceLock(rls);  
if (__CFRunLoopSourceIsSignaled(rls)) {  
    __CFRunLoopSourceUnsetSignaled(rls);  
    if (__CFIsValid(rls)) {  
        __CFRunLoopSourceUnlock(rls);  
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(rls->_context.version0.perform, rls->_context.version0.info);  
        CHECK_FOR_FORK();  
        sourceHandled = true;  
    } else {  
        __CFRunLoopSourceUnlock(rls);  
    }  
} else {  
	 __CFRunLoopSourceUnlock(rls);  
}  
}  
```  